# FakeFutbinSollution
### `Learning project which combines ASP.NET Web Core API and Blazor Web Assembly App`

#### I Database creation
1) Two NuGet Packages: [Tools and Sql](https://user-images.githubusercontent.com/94840984/220696122-b70c0cd6-c6d1-4eda-b129-b046b39773e2.png) added.
2) [Entities](https://user-images.githubusercontent.com/94840984/220696557-b6148828-3982-448a-8aeb-2868ca74df04.png) which represent database tables created.
3) `FakeFutbinDbContext.cs` class created: [Part 1](https://user-images.githubusercontent.com/94840984/220697934-89745529-045b-4bf6-aa52-93984551e9ba.png) and [Part 2](https://user-images.githubusercontent.com/94840984/220698255-73d74868-a73d-4c2a-996a-fa21306e8fc2.png). This class uses `ModelBuilder` to create some new records for `Players`, `PlayerNationalities` and `Positions` tables. `DbSet.cs` class was used to create tables and specify their names.
4) [Connection String](https://user-images.githubusercontent.com/94840984/220695822-34894036-011b-41a5-a989-68f2d90f5c49.png) written. 
5) [`FakeFutbinDbContext.cs` added to `DbContextPool` using `SqlServer` and custom connection string](https://user-images.githubusercontent.com/94840984/220700230-435d193d-26ed-49b6-8841-f1f44cd06dfd.png).
6) Migration created with `Package Manager Console` using `Add-Migration MigrationName` and `Update-Database` commands: [Database Tables](https://user-images.githubusercontent.com/94840984/220702488-41f27d45-f32b-402d-8a23-093530079c23.png).
##### Last *MigrationName* was `PositionsTableAdded`, but it was used multiple times during the project creation and development.
#### II `FakeFutbin.Api` (ASP.NET Web Core API) project combined with `FakeFutbin.Web` (Blazor Web Assembly App) project.
1) [Avoiding Cors Policy](https://user-images.githubusercontent.com/94840984/220705767-fa2d7eff-849c-47f8-b49b-4b2d41929167.png) in `FakeFutbin.Api` project.
2) [Local host address](https://user-images.githubusercontent.com/94840984/220705993-3ad7a6c1-bc33-4239-8026-3ff5c9dbc756.png) added in `FakeFutbin.Web` project.
#### III `PlayerRepository.cs`, data transfer objects, conversion methods and `PlayerController.cs`
1) [`IPlayerRepository.cs`](https://user-images.githubusercontent.com/94840984/220715593-5dd5c15a-ea94-44d7-9d9a-43ab88420c8d.png) interface created.
2) [`PlayerRepository.cs`](https://user-images.githubusercontent.com/94840984/220715790-8a43c9d4-39c5-4e4f-8d50-f9f4b261c0fa.png) class which implements `IPlayerRepository.cs` interface created. `FakeFutbinDbContext.cs` dependencies injected into `PlayerRepository.cs` class in constructor. Due to methods written in this class data from database tables:  `Players` and `PlayerNationalities` are available in controller.
3) [`IPlayerRepository.cs` interface and `PlayerRepository.cs` class registred for dependency injection](https://user-images.githubusercontent.com/94840984/220720059-aa4546bc-23c4-4ec5-9571-3518d3a2906e.png).
4) [Data transfer objects `PlayerDto.cs` and `PlayerNationalityDto.cs`](https://user-images.githubusercontent.com/94840984/220721956-2e57257a-cb94-4e01-9a6f-7335a7a3f3b1.png) created.
5) Conversion methods which use dtos for `PlayerController.cs` methods: [for `GetPlayers()` and `GetPlayersByNationality()`](https://user-images.githubusercontent.com/94840984/220720652-8cf709c3-f934-41c1-9cd8-f59d19c5e37c.png), [for `GetPlayer()`](https://user-images.githubusercontent.com/94840984/220721387-a404b2dc-17b1-4dba-ac6f-c4ed65cb0bd9.png) and [for `GetPlayerNationalities()`](https://user-images.githubusercontent.com/94840984/220721706-8b54f2e8-5e12-4c23-aaa3-466c7e0c321c.png).
6) API controller: [`PlayerController.cs` Part1](https://user-images.githubusercontent.com/94840984/220723455-a348a5f9-192c-4feb-a6d6-c95f457dad97.png), [`PlayerController.cs` Part2](https://user-images.githubusercontent.com/94840984/220723948-5efddfa1-61b6-4788-8469-cc1cbde4d339.png) and [`PlayerController.cs` Part3](https://user-images.githubusercontent.com/94840984/220724292-dc0cd6b7-1cd4-4106-bd33-5b8bf4efe9fd.png). This controller includes `GET` methods which only enable other objects to get data from database tables `Players` and `PlayerNationalities` using `PlayerRepository.cs` class methods and conversion methods from `DtoConversions.cs` class. `PlayerRepository.cs` dependencies was injected in controller class constructor using `IPlayerRepository.cs` interface. 
#### IV `PositionRepository.cs`, data transfer objects, conversion methods and `PositionController.cs`
1) [`IPositionRepository.cs`](https://user-images.githubusercontent.com/94840984/220911169-d87b9165-fba5-45d1-b3da-8f72093c52b7.png)interface created.
2) [`PositionRepository.cs`](https://user-images.githubusercontent.com/94840984/220911567-82df3e0e-ef94-42ad-ba77-b9b85c0bf97e.png) class which implements `IPositionRepository.cs` interface created. `FakeFutbinDbContext.cs` dependencies injected into `PositionRepository.cs` class in constructor. Due to methods written in this class data from database table: `Positions` is available in controller.
3) [`IPositionRepository.cs` interface and `PositionRepository.cs` class registred for dependency injection](https://user-images.githubusercontent.com/94840984/220896380-401db3cb-4e0f-42f2-b9e3-8c6aff219e39.png).
4) [Data transfer objects `PositionDto.cs` and `UserPlayerPositionDto.cs`](https://user-images.githubusercontent.com/94840984/220913409-dd484752-4842-4911-b85d-da5d3172c854.png) created. 
5) Conversion methods which use dto for `PositionController.cs` class: [for `GetPositions()` and `UpdatePosition()` methods](https://user-images.githubusercontent.com/94840984/220913823-a84e48a5-e977-4249-a687-2f68905a2b47.png).
6) API controller: [`PositionController.cs`](https://user-images.githubusercontent.com/94840984/220914353-333983b4-425b-47e2-834e-66373d4ac0f6.png) created. This controller has two methods: 
- `GetPositions()` is a `GET` method which enables other objects to get data from database table `Positions`;
- `UpdatePosition()` is a `PATCH` method which enable other objects to update data in `UserPlayers` table. 
Both methods use `PositionRepository.cs` class methods and conversion methods from `DtoConversions.cs` class. `PositionRepository.cs` dependencies was injected in controller class constructor using `IPositionRepository.cs` interface. 
#### V `UserRepository.cs`, data transfer objects, conversion methods and `UserController.cs`
1) [`IUserRepository.cs`](https://user-images.githubusercontent.com/94840984/220926910-a22e317a-9d84-469a-b9de-70613218e512.png) interface created.
2) `UserRepository.cs` class which implements `IUserRepository.cs` interface created: [`UserRepository.cs` Part1](https://user-images.githubusercontent.com/94840984/220927198-15273639-1afd-477c-bd6b-4014e08df610.png), [`UserRepository.cs` Part2](https://user-images.githubusercontent.com/94840984/220928173-840ff517-d1e5-462a-a416-ea6649dee61d.png) and [`UserRepository.cs` Part3](https://user-images.githubusercontent.com/94840984/220928268-36e1313c-ef6c-449b-a6d7-b0e8353474f4.png). `FakeFutbinDbContext.cs` dependencies injected into `PlayerRepository.cs` class in constructor. Due to methods written in this class data from database tables:  `Users` and `UserPlayers` are available in controller.
3) [`IUserRepository.cs` interface and `UserRepository.cs` class registred for dependency injection](https://user-images.githubusercontent.com/94840984/220929261-55930576-d78b-44f7-8cb2-cc4306450864.png).
4) [Data transfer objects `UserPlayerDto.cs` and `UserWalletDto.cs`](https://user-images.githubusercontent.com/94840984/220929931-56bc1356-1603-47ef-bf49-7a5f517c437b.png) created.
5) [Conversion methods which use dtos for `UserController.cs` methods](https://user-images.githubusercontent.com/94840984/220931657-9817117b-867f-4f79-b453-5890ac0ffaf7.png)
6) API controller: [`UserController.cs` Part1](https://user-images.githubusercontent.com/94840984/220932120-d30d26e0-ebb9-4468-91a9-80a7d9994e6e.png), [`UserController.cs` Part2](https://user-images.githubusercontent.com/94840984/220932240-bfb9e308-ca61-4b86-a3f5-cc84cc35bce5.png) and [`UserController.cs` Part3](https://user-images.githubusercontent.com/94840984/220932319-63e0e9b0-9967-4eb6-990f-88409b7ab6f7.png). Controller methods:
- `GetUsers()` is a `GET` method which allows other objects to get specified data from database `Users` table; 
- `GetPlayers()` is a `GET` method which enables other objects to get data from database `UserPlayers()` table; 
- `GetUser()` is a `GET` method which allows other objects to get single user's specified data from database `Users` table selected by user's id;
- `GetPlayer()` is a `GET` method which allows other objects to get single user player specified data from database `UserPlayers` table selected by user player's id;
- `PostPlayer()` is a `POST` method allows other objects to add a player from database `Players` table to database `UserPlayers` table; 
- `DeletePlayer()` is a `DELETE` method which enable other objects to delete players from database `UserPlayers` table; 
- `UpdateQty()` is a `PATCH` method which allows other objects to update `Qty` field for single user player selected by user player's id in database `UserPlayers` table.
- `UpdateWallet()` is a `PATCH` method which enables other objects to update `Wallet` field for single user selected by user's id in database `Users` table.  

All these methods use `UserRepository.cs` class methods or `PlayerRepository.cs` class methods or both and appropriate conversion methods from `DtoConversions.cs` class. `UserRepository.cs` and `PlayerRepository.cs` dependencies was injected in controller class constructor using `IUserRepository.cs` and `IPLayerRepository` interfaces. 
#### VI User Registeration, Login and Authentication using Refresh Jason Web Token
1) [Instalation of required NuGet packages](https://user-images.githubusercontent.com/94840984/220969128-45aa6fb5-c049-4890-810d-74c54ac91d38.png).
2) [Special Token hidden in `appsettings.json` file](https://user-images.githubusercontent.com/94840984/220969412-5aed813b-3bbf-4f0e-b473-6fe08ff67515.png) written.
3) [Security Scheme with Token Bearer scheme created and `IAuthRepository.cs` interface and `AuthRepository.cs` class registered for dependency injcetion](https://user-images.githubusercontent.com/94840984/220969926-ee8e8e70-dd5b-4e7d-8d0f-af7266aff2e5.png).
4) [Authentication using Sepcial Token and `HttpContextAccessor` added](https://user-images.githubusercontent.com/94840984/220970781-3d4bd583-51f7-4674-99b5-9d8d88674181.png), [Authentication activation](https://user-images.githubusercontent.com/94840984/220971823-070afefa-2328-477c-a45c-4ae57db233aa.png).
5) [`RefreshToken.cs`](https://user-images.githubusercontent.com/94840984/221377107-3731a3d5-c0fd-4c43-ad77-e87f5788ad52.png) class created which is used in the API, but it doesn't have a table in database.
6) [Data transfer objects `UserDto.cs`](https://user-images.githubusercontent.com/94840984/221377179-6bbaf63d-8e8a-4c04-aa82-4ffda1bb94e8.png) and [`AuthResponseDto.cs`](https://user-images.githubusercontent.com/94840984/221377419-ca7e635c-92bc-47e7-976c-4459292d8048.png) created.
7) [`IAuthRepository.cs`](https://user-images.githubusercontent.com/94840984/221377283-1ebd13c9-fcf9-4e9b-835c-b5ac6ee469d7.png) interface created.
8) `AuthRepository.cs` class which implements `IAuthRepository.cs` interface created: [`AuthRepository.cs` Part1](https://user-images.githubusercontent.com/94840984/221377530-1ed1e21d-84c9-419a-8e02-5435454a8c7f.png), [`AuthRepository.cs` Part2](https://user-images.githubusercontent.com/94840984/221377587-66531b3b-0a35-4601-9a02-fb4e45101814.png) and [`AuthRepository.cs` Part3](https://user-images.githubusercontent.com/94840984/221377600-b738b168-2d8d-48e7-a6bf-9ac84fcb8eaf.png). In class contructor was added `FakeFutbinDbContext.cs`, `IConfiguration.cs` and `IHttpContextAccessor.cs` for dependency injection. `AuthRepository.cs` class methods:
- `RegisterUser()` method creates new record which is also a new user in database `Users` table. It set username, role: "User", 1000000 coins to the wallet and uses `CreatePasswordHash()` method to create and encrypt password with HMACSHA512 encryption algorithm.
- `Login()` method first checks if user exists in the database, when it is true then it checks if password is correct using `VerifyPasswordHash()` method and then it invokes `CreateToken()`, `CreateRefreshToken()`,`SetRefreshToken()` methods and returns new `AuthResponseDto`.
- `CreateToken()` method uses `Claims` class to set `ClaimTypes`: user's Id as NameIdentifier, Username as Name and user's Role as Role. This informations are encrypted HMACSHA512 encryption algorithm using Sepcial Token from `appsettings.json` file as security key. It creates `Jason Web Token`,  writes it using `JwtSecurityTokenHandler` and returns it.
- `CreateRefreshToken()` method creates new `RefreshToken` entity using `RandomNumberGenerator` class and set it's expiration time for 7 days.
- `SetRefreshToken()` method adds refresh token to cookies using `HttpContextAccessor` and set it to user and saves it in database `Users` table.
- `RefreshToken()` method first chceks if user exists in the database, then chceks if token in database is not expierd. It uses `CreateToken()`, `CreateRefreshToken()` and `SetRefreshToken()` methods and returns new `AuthResponseDto`.
9) [`AutController.cs`](https://user-images.githubusercontent.com/94840984/221380133-503bc92a-9309-49fb-b13c-c22cc119470b.png) created. `AuthRepository.cs` and `FakeFutbinDbContext.cs` classes registered for dependency injection in controller class constructor. `RegisterUser()` and `Login()` methods allows othet objects to register new users and login them into the website.

In database [`Users` table](https://user-images.githubusercontent.com/94840984/221381859-5fbd59bb-a80c-4155-ae6f-32c19c6c5e8d.png) is stored only the refresh token which hides the Jason Web Token. It is only availables in [Local Storage](https://user-images.githubusercontent.com/94840984/221381917-38820022-6cac-4651-b394-7fe10c4010b0.png). Claims which are included in JWT can be decrypted on [jwt.io site](https://user-images.githubusercontent.com/94840984/221381962-acf766ef-6027-4c76-865b-76213cf7b593.png).
